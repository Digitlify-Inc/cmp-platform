# GSV Platform - Secrets Management

## Overview

Secrets are created once during initial deployment and are never stored in git. This document explains how secrets are managed in the GSV Platform.

## Phase 1: Manual Secrets (GTM)

During the GTM phase, secrets are created manually using the provided script.

### Required Secrets

| Secret | Namespace | Purpose | Required For |
|--------|-----------|---------|--------------|
| `repo-creds-config` | argocd | GitHub access token | All deployments |
| `cnpg-*-superuser` | cnpg-system | Database passwords | All deployments |
| `cloudflare-api-token` | cert-manager | DNS-01 challenges | Cloud deployments |
| `keycloak-admin` | keycloak | Keycloak admin | All deployments |
| `grafana-admin` | observability | Grafana admin | All deployments |

### Creating Secrets

#### Interactive Mode

```bash
./scripts/create-secrets.sh --env dev --provider kind
```

The script will prompt for each secret interactively.

#### Non-Interactive Mode

Set environment variables and run with `--non-interactive`:

```bash
export GITHUB_TOKEN="ghp_xxxxxxxxxxxx"
export CLOUDFLARE_TOKEN="xxxxxxxxxxxx"

./scripts/create-secrets.sh --env prod --provider hetzner --non-interactive
```

### GitHub Token

Required for ArgoCD to access private repositories.

1. Go to https://github.com/settings/tokens
2. Generate new token (classic)
3. Select scopes: `repo` (full control)
4. Copy the token

```bash
# The script will prompt for this
# Or set via environment variable:
export GITHUB_TOKEN="ghp_xxxxxxxxxxxx"
```

### Cloudflare API Token

Required for DNS-01 certificate challenges (cloud deployments only).

1. Go to https://dash.cloudflare.com/profile/api-tokens
2. Create token with permissions:
   - Zone: DNS: Edit
   - Zone: Zone: Read
3. Select zone resources (your domain)

```bash
export CLOUDFLARE_TOKEN="xxxxxxxxxxxx"
```

### Database Passwords

CNPG database passwords are auto-generated by the script using secure random values.

If you need to retrieve a password later:

```bash
# Get CMP database password
kubectl get secret cmp-postgres-superuser -n cnpg-system \
  -o jsonpath='{.data.password}' | base64 -d

# Get Keycloak database password
kubectl get secret keycloak-postgres-superuser -n cnpg-system \
  -o jsonpath='{.data.password}' | base64 -d
```

## Secret Rotation

### Manual Rotation

1. Delete the existing secret:
   ```bash
   kubectl delete secret <secret-name> -n <namespace>
   ```

2. Re-run the secrets script:
   ```bash
   ./scripts/create-secrets.sh --env <env> --provider <provider>
   ```

3. Restart affected pods:
   ```bash
   kubectl rollout restart deployment/<app> -n <namespace>
   ```

### Database Password Rotation

For CNPG databases, password rotation requires:

1. Update the secret:
   ```bash
   kubectl create secret generic <cluster>-superuser \
     --namespace cnpg-system \
     --from-literal=username=postgres \
     --from-literal=password=<new-password> \
     --dry-run=client -o yaml | kubectl apply -f -
   ```

2. CNPG will automatically pick up the new password.

## Phase 2: External Secrets (Post-GTM)

After GTM, secrets will be managed via:

- **HashiCorp Vault** - Central secret storage
- **External Secrets Operator (ESO)** - Syncs secrets to Kubernetes

### Architecture

```
┌──────────────┐     ┌─────────────────────┐     ┌────────────────┐
│   Vault      │────▶│ External Secrets    │────▶│ K8s Secrets    │
│  (Central)   │     │ Operator (ESO)      │     │ (Auto-synced)  │
└──────────────┘     └─────────────────────┘     └────────────────┘
```

### Benefits

- Centralized secret management
- Automatic rotation
- Audit logging
- Multi-cluster support

## Security Best Practices

### DO

- ✅ Use strong, randomly generated passwords
- ✅ Rotate secrets regularly
- ✅ Limit secret access via RBAC
- ✅ Use namespaced secrets
- ✅ Back up secrets securely

### DON'T

- ❌ Commit secrets to git
- ❌ Share secrets via insecure channels
- ❌ Use the same secret across environments
- ❌ Log secret values
- ❌ Hard-code secrets in application code

## Backup and Recovery

### Exporting Secrets (for backup)

```bash
# Export all secrets from a namespace (base64 encoded)
kubectl get secrets -n <namespace> -o yaml > secrets-backup.yaml

# IMPORTANT: Store this file securely and encrypted!
```

### Restoring Secrets

```bash
kubectl apply -f secrets-backup.yaml
```

## Troubleshooting

### ArgoCD Can't Access Repository

```bash
# Check if secret exists
kubectl get secret repo-creds-config -n argocd

# Check secret content (careful - this shows the token!)
kubectl get secret repo-creds-config -n argocd -o yaml

# Re-create if needed
kubectl delete secret repo-creds-config -n argocd
./scripts/create-secrets.sh --env <env> --provider <provider>
```

### Certificate Challenges Failing

```bash
# Check Cloudflare token secret
kubectl get secret cloudflare-api-token -n cert-manager

# Check cert-manager logs
kubectl logs -n cert-manager -l app=cert-manager

# Verify token permissions at Cloudflare dashboard
```

### Database Connection Errors

```bash
# Check CNPG cluster status
kubectl get cluster -n cnpg-system

# Check secret exists
kubectl get secret <cluster>-superuser -n cnpg-system

# View password (careful!)
kubectl get secret <cluster>-superuser -n cnpg-system \
  -o jsonpath='{.data.password}' | base64 -d
```
